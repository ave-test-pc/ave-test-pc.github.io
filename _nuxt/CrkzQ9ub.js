import{f as e,ak as a,by as s,v as t,an as l,bR as i,U as o,V as n,bS as r,y as u,m as d,I as c,a1 as p,cL as m,ao as v,bv as f,cy as b,bu as h,b$ as _,g,bP as x,r as k,T as y,n as w,lY as N,O as j,ap as S,i as A,c as T,o as $,a as F,b as C,K as I,B as E,w as R,d as V,t as W,aH as L,s as U,F as z,D as P,e as B,a7 as H,a6 as M,C as O,a0 as D,G,ah as J,H as K,J as Y,aR as Z,cp as q,ae as X,bU as Q,bV as ee,bW as ae,bY as se,bZ as te,b_ as le}from"./C0VmCwYl.js";import{_ as ie}from"./vdVtd-py.js";import{E as oe}from"./zMOKQAqQ.js";import{_ as ne}from"./C0O8vvG5.js";import{r as re,u as ue}from"./CMghWc-o.js";import{b as de}from"./BvQ8kGpd.js";import{u as ce}from"./D6hHWCBQ.js";import"./C6Y8sTuD.js";import"./DpxIxQTC.js";import"./D2KqFhI7.js";import"./C8VmjICj.js";import"./zxXvcpOJ.js";import"./4hQHbeZj.js";import"./CJ5C3yTe.js";import"./BfdQ9pQL.js";import"./D6OzSheD.js";import"./CyDNo-31.js";import"./oYLRChA3.js";import"./Bn0Mo5PC.js";import"./-_IRfLaa.js";import"./B4HE3f45.js";import"./rhYgSr0o.js";import"./DxTPb_Mm.js";import"./DSDI11qA.js";import"./CIMJ110g.js";const pe={class:"flex justify-between items-center mt-10px pr-15px"},me=["infinite-scroll-disabled"],ve={class:"pr-10px pb-20px"},fe={class:"flex-[1.5] flex items-center"},be={class:"ml-6px"},he={class:"flex"},_e={class:"color-[var(--main-text)]"},ge={class:"mt-2px color-[--third-text]"},xe={class:"flex-1 flex flex-col items-end"},ke={class:"flex-1 flex justify-end"},ye={key:1,class:"color-[var(--d-EAECEF-l-333)]"},we={key:0,class:"color-#959a9f text-12px text-center"},Ne=e({__name:"positionsTable",props:{height:{type:[Number,String],default:370}},setup(e){const{updateHolderNum:Ne}=a(s()),{t:je}=t(),Se=l(),Ae=i(),Te=o(),$e=de(),Fe=ce(),Ce=n(),Ie=r(),{hide_risk:Ee,hide_small:Re}=a(u());function Ve(){Ke.value.pageNo=1,Ke.value.finished=!1}d((()=>Se.wsResult[v.PRICEV2]),(e=>{const a={};e.prices.forEach((e=>{a[e.token+"-"+e.chain]=e})),Ye.value=Ye.value.map((e=>{const s=a[e.index];if(s&&s.uprice>0){const a="--"===e.total_profit||0===Number(e.total_profit),t=new p(e.balance||0).times(s.uprice||0);if(a)return{...e,current_price_usd:s.uprice,balance_usd:t.toNumber()};{const a=new p(e.balance_usd||0).minus(e.total_profit||0),l=t.minus(a),i=new p(s.uprice||0).minus(e.average_purchase_price_usd||0).div(e.average_purchase_price_usd);return i.toNumber()<-1||Number(e.average_purchase_price_usd)<0?e:{...e,current_price_usd:s.uprice,balance_usd:t.toNumber(),total_profit:l.toFixed(),total_profit_ratio:i.toFixed()}}}return e})),m(Ye)})),d((()=>Ne.value),(()=>{Ve(),Me()})),d((()=>Se.wsResult[v.ASSET]),(e=>{var a;if(e.swap){const a="So11111111111111111111111111111111111111112"===e.swap.token||e.swap.token===b?b:e.swap.token,s=e.swap.chain;a&&s&&setTimeout((()=>{Ve(),Me()}),5e3)}else if(e.transfer){const s=e.transfer.chain,t=e.transfer.token,l=e.transfer.type;if(t&&s){const i=Ye.value.findIndex((e=>e.token===t&&e.chain===s)),o="0"===l;if(i>-1){const s=Ye.value[i],t=Number(s.balance),l=s.current_price_usd,n=new p(t).plus(o?e.transfer.amount:-(null==(a=e.transfer)?void 0:a.amount)),r=n.multipliedBy(l);s.balance=n.toString(),s.balance_usd=r.toNumber(),m(Ye)}else setTimeout((()=>{Ve(),Me()}),5e3)}}})),h((function(e,a){const s=Te.getWalletAddress(a);s&&_({chain:a,walletAddress:s,tokens:[e]}).then((s=>{Ye.value=Ye.value.map((t=>t.token===e&&t.chain===a?{...t,balance:s[0].balance,balance_usd:new p(s[0].balance||0).times(t.current_price_usd||0).toNumber()}:{...t}))}))}),1e3,!1,!0);const We=g((()=>{var e;return"evm"===(null==(e=x(Ce.chain))?void 0:e.vm_type)})),Le=g((()=>Te.userInfo?Te.userInfo.addresses.map((({address:e,chain:a})=>e+"-"+a)):Ce.address&&We.value&&"WatchWallet"!==Ce.walletName?[Ce.address+"-bsc",Ce.address+"-base",Ce.address+"-eth"]:[Ce.address+"-"+Ce.chain]));d((()=>Le.value),(()=>{Ue.value.user_ids=Le.value}));const Ue=k({hide_risk:Ee,hide_small:Re,user_ids:Le.value}),ze=k({}),Pe=e,Be=g((()=>Number(Pe.height)-110)),He=y("scrollContainerRef"),Me=f((()=>{const{value:e}=He;e&&e.scrollHeight<=e.clientHeight&&!Ke.value.finished&&Ze()}),200);d(Be,Me);const Oe=c({sortBy:void 0,activeSort:0}),De={"-1":"asc",1:"desc"},Ge=g((()=>({sort_dir:De[Oe.value.activeSort],sort:Oe.value.sortBy}))),Je=g((()=>[{label:`${je("token")}/${je("balance1")}`,value:"balance_usd",flex:"flex-[1.5]",sort:!0},{label:je("profit2"),value:"total_profit",flex:"flex-1 justify-end",sort:!0},{label:"",value:"",flex:"flex-1 justify-end",sort:!1}])),Ke=c({finished:!1,loading:!1,pageNo:1,pageSize:10}),Ye=c([]);async function Ze(){try{Ke.value.loading=!0;const e=Ke.value.pageNo,a=await N({pageNO:Ke.value.pageNo,pageSize:Ke.value.pageSize,...Ue.value,...Ge.value});if(Array.isArray(null==a?void 0:a.data)&&a.data.length>0){if(1===e)Ye.value=a.data.map((e=>{var a;return{...e,index:e.token===b?(null==(a=x(e.chain))?void 0:a.wmain_wrapper)+"-"+e.chain:`${e.token}-${e.chain}`}}));else{const e=a.data.filter((e=>Ye.value.every((a=>a.index!==`${e.token}-${e.chain}`)))).map((e=>{var a;return{...e,index:e.token===b?(null==(a=x(e.chain))?void 0:a.wmain_wrapper)+"-"+e.chain:`${e.token}-${e.chain}`}}));Ye.value=Ye.value.concat(e)}Ke.value.finished=a.data.length<Ke.value.pageSize,Ke.value.finished||Ke.value.pageNo++}else 1===Ke.value.pageNo&&(Ye.value=[]);Fe.setMultiPriceParams("positions",Ye.value.map((e=>e.token+"-"+e.chain))),Fe.sendPriceWs()}catch(e){}finally{Ke.value.loading=!1,m(Ke)}}async function qe(e){if(!X())return;if(!e.token)return;const a=Te.getWalletAddress(e.chain);if(a)try{ze.value[e.index]=!0;const s=(await _({chain:e.chain,tokens:[e.token],walletAddress:a}))[0];s&&(e.balance=s.balance||0,e.balance_usd=new p(s.balance||0).times(e.current_price_usd||0).toNumber(),e.decimals=s.decimals||e.decimals);const t=s.balance||0;if(!t)return void Q({title:"Error",type:"error",message:s("insufficientBalance")});await $e.checkApproveAndApprove({chain:e.chain,token:e.token,owner:a}),function(e,a){var s;if(!X())return;if(new p(e||0).lte(0))return void Q({title:"Error",type:"error",message:je("amountMustG0")});const t=null==(s=new p(e||0).toFixed().match(new RegExp(`[0-9]*(\\.[0-9]{0,${a.decimals||18}})?`)))?void 0:s[0];if((Number(t)||0)<=0)return void Q({title:"Error",type:"error",message:je("amountTooSmall")});ze.value[a.index]=!0,async function(e,a){var s,t,l;const i="solana"===a.chain,{botSettings:o}=Ae,n=null==(s=null==o?void 0:o[a.chain])?void 0:s.selected,r=null==(t=null==o?void 0:o[a.chain])?void 0:t[n];if(i&&(null==r?void 0:r.mev)&&!(await Te.getBundleAvailable()))return void(ze.value[a.index]=!1);const{gasTip1List:u,gasTip2List:c}=ee(ae().gasTip,"solana"),m=(null==r?void 0:r.mev)?u:c,v=(null==r?void 0:r.mev)?null==r?void 0:r.gas[0]:null==(l=null==r?void 0:r.gas)?void 0:l[1];let f={};if(i){let e=(null==v?void 0:v.customFee)||(null==m?void 0:m[null==v?void 0:v.level])||"0.002";(null==r?void 0:r.mev)&&new p(e).lt("0.002")&&(e="0.002"),f.priorityFee=new p(e).times(10**9).toFixed(0)}else{const e=0===Number(null==v?void 0:v.customFee)?"0":(null==v?void 0:v.customFee)||(null==m?void 0:m[null==v?void 0:v.level])||"3";f.gasTip=Number(new p(e).times(10**9).toFixed(0)),f.contractType=0,f.chain=a.chain}const h={solana:"sol",ton:"TON"}[a.chain]||b,_=(null==r?void 0:r.slippage)||"9",g=Te.getWalletAddress(a.chain);if(!g)return;f={...f,batchId:Date.now().toString(),swapList:[{creatorAddress:g,inAmount:new p(e||0).times(10**a.decimals||0).toFixed(0)}],inTokenAddress:a.token,outTokenAddress:h,swapType:2,isPrivate:(null==r?void 0:r.mev)||!1,slippage:"auto"!==_?Number(new p(_).times(100).toFixed(0)):900};(i?se(f):te(f)).then((e=>function(e,a,s,t){if(e){let l=setTimeout((()=>{Q({type:"success",message:je("transactionsSubmitted")}),Ie.placeOrderUpdate++,ze.value[s]=!1}),500);const i=(null==t?void 0:t.chain)||"",o=(null==e?void 0:e[0])||{};re({txInfo:o,chain:i,destination:"solana"===i?"/botapi/swap/createSolTx":"/botapi/swap/createSwapEvmTx",type:10});const n={[null==o?void 0:o.batchId]:null==o?void 0:o.id},r=d((()=>Se.wsResult.tgbot),(e=>{var t,i,o,u,d;const c=e.batchId;if(c===a){if(l&&(clearTimeout(l),l=null),Ie.placeOrderSuccess++,null==(i=null==(t=null==e?void 0:e.txList)?void 0:t[0])?void 0:i.success){Q({type:"success",message:je("tradeSuccess")});const a=null==(o=null==e?void 0:e.txList)?void 0:o[0];ue({...a,chain:null==e?void 0:e.chain},(null==n?void 0:n[c])||"")}else le((null==(d=null==(u=null==e?void 0:e.txList)?void 0:u[0])?void 0:d.failMessage)||"swap error");r(),ze.value[s]=!1}}))}}(e,f.batchId,a.index,a))).catch((e=>{le(e||"swap error"),ze.value[a.index]=!1}))}(e,a)}(t,e)}finally{ze.value[e.index]=!1}}return w((()=>{Ze()})),d((()=>[Ge.value,Ue.value.hide_risk,Ue.value.hide_small,Te.evmAddress,()=>Ce.address,()=>Ce.walletSignature[Ce.address]]),(()=>{Ve(),Ze()})),(e,a)=>{const s=L,t=ie,l=M,i=H,o=O,n=K,r=B,u=Z,d=oe,c=q,p=S;return j(($(),T("div",null,[F("div",pe,[C(s,{modelValue:A(Ue).hide_risk,"onUpdate:modelValue":a[0]||(a[0]=e=>A(Ue).hide_risk=e),class:"ml-12px",style:{marginRight:0},size:"small","true-value":1,"false-value":0},{default:R((()=>[V(W(e.$t("hideRiskTokenShort")),1)])),_:1},8,["modelValue"]),C(s,{modelValue:A(Ue).hide_small,"onUpdate:modelValue":a[1]||(a[1]=e=>A(Ue).hide_small=e),size:"small","true-value":1,"false-value":0},{default:R((()=>[V(W(e.$t("hideSmallAssets1")+"<1USD"),1)])),_:1},8,["modelValue"]),A(Te).evmAddress||A(Ce).address&&A(We)&&"WatchWallet"!==A(Ce).walletName?($(),I(t,{key:0,userIds:A(Ue).user_ids,"onUpdate:userIds":[a[2]||(a[2]=e=>A(Ue).user_ids=e),a[3]||(a[3]=e=>{Ve(),Ze()})]},null,8,["userIds"])):E("",!0)]),C(ne,{sort:A(Oe),"onUpdate:sort":a[4]||(a[4]=e=>U(Oe)?Oe.value=e:null),columns:A(Je)},null,8,["sort","columns"]),C(d,{height:A(Be)},{default:R((()=>[j(($(),T("div",{ref_key:"scrollContainerRef",ref:He,"infinite-scroll-disabled":A(Ke).finished||A(Ke).loading,"infinite-scroll-distance":"200","infinite-scroll-delay":10,"infinite-scroll-immediate":!1},[F("div",ve,[($(!0),T(z,null,P(A(Ye),((a,s)=>($(),I(r,{key:s,class:"text-12px flex justify-between pl-10px py-10px cursor-pointer hover:bg-[--dialog-bg]",to:`/token/${a.index}`},{default:R((()=>[F("div",fe,[C(i,{"popper-class":"tooltip-pd-0",placement:"bottom-start","show-arrow":!1},{default:R((()=>[C(l,{row:a},null,8,["row"])])),content:R((()=>[C(l,{row:a,"chain-class":"hidden","token-class":"w-240px h-240px [&&]:mr-0 rounded-16px"},null,8,["row"])])),_:2},1024),F("div",be,[F("div",he,[F("span",_e,W(a.symbol),1),a.risk_score>55||a.risk_level<0?($(),I(o,{key:0,name:"custom:danger",class:"font-14 ml-2px color-#F72121"})):E("",!0)]),F("div",ge,[0===a.balance?($(),T(z,{key:0},[V("$0")],64)):"--"===a.balance?($(),T(z,{key:1},[V("--")],64)):($(),T(z,{key:2},[V(W(("formatNumber"in e?e.formatNumber:A(D))(a.balance,2))+"("+W("$"+("formatNumber"in e?e.formatNumber:A(D))(a.balance_usd||0,2))+") ",1)],64))])])]),F("div",xe,[F("div",{class:G(("getColorClass"in e?e.getColorClass:A(J))(a.total_profit))},[0===Number(a.total_profit)?($(),T(z,{key:0},[V("0")],64)):"--"===a.total_profit?($(),T(z,{key:1},[V("--")],64)):($(),T(z,{key:2},[V(W(Number(a.total_profit)>0?"$":"-$")+W(("formatNumber"in e?e.formatNumber:A(D))(Math.abs(Number(a.total_profit)),2)),1)],64))],2),F("div",{class:G(("getColorClass"in e?e.getColorClass:A(J))(a.total_profit_ratio))},[0===Number(a.total_profit_ratio)?($(),T(z,{key:0},[V("0")],64)):"--"===a.total_profit_ratio?($(),T(z,{key:1},[V("--")],64)):($(),T(z,{key:2},[V(W(Number(a.total_profit_ratio)>0?"+":"-")+W(("formatNumber"in e?e.formatNumber:A(D))(Math.abs(100*Number(a.total_profit_ratio)),2))+"% ",1)],64))],2)]),F("div",ke,[A(Te).evmAddress&&"0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee"!==a.token?($(),I(n,{key:0,size:"small",loading:A(ze)[a.index],class:"[--el-border:0] [&&]:[--el-button-bg-color:--d-222-l-F2F2F2] [&&]:font-normal",style:{padding:"4px"},onClick:Y((e=>qe(a)),["stop","prevent"])},{default:R((()=>[V(W(e.$t("closePosition")),1)])),_:2},1032,["loading","onClick"])):($(),T("span",ye,"--"))])])),_:2},1032,["to"])))),128)),0!==A(Ye).length||A(Ke).loading?E("",!0):($(),I(u,{key:0}))]),A(Ke).loading&&1!==A(Ke).pageNo?($(),T("div",we,W(e.$t("loading")),1)):E("",!0)],8,me)),[[c,Ze]])])),_:1},8,["height"])])),[[p,A(Ke).loading&&1===A(Ke).pageNo]])}}});export{Ne as default};
